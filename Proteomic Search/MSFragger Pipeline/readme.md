# Two Pass Database Search for PRF with FragPipe 

## Two Pass Search Strategy
This analysis begins with a 2-pass search of MS datasets using Fragpipe 23.1. The initial pass serves to identify canonical/native peptides in the datasets to identify peptides from native protein sequences using the UniProt reviewed canonical and isoform database with decoys and contaminants. The Fragpipe workflow for the first pass differs based on the fragmentation method used for tandem MS. HCD/CAD methods produce b and y ions, and identification was validated using MSBooster (DIA-NN models), along with Percolator and Protein Prophet. ETD methods produce c and z ions, which was validated with Percolator and Protein Prophet. The workflow of the first pass search sets up the second pass by writing sub.mzML files with scans corresponding to canonical peptides removed, but maintains the scan numbers of remaining data; the output of the first pass includes a new workflow and manifest file for the second pass search.

The workflow for the second pass was utilized for the search without modifications, and possible frameshift peptide products were identified using a custom .fasta database containing predicted chimeric frameshift sequences along with decoys and contaminants.

Representative workflow files and manifests of the first and second pass can be found in the /search_files directory, along with job submission scripts used to initiate the search on compute clusters.

The relevant outputs of the second pass search that were used in this analysis can be found in the /results directory, grouped according to the enzyme and activation method used to generate the data and perform the searches.

## Analysis of Second Pass Search

/analysis contains the .R and .py scripts used to analyze the results of the second pass search:

### Generating a List of Identified Peptides

The combined_peptide.tsv files from the second pass searches were analyzed with 01_second_pass_output.R which generates all_peptides.txt/.tsv - a list/table of all the identified peptides from the second pass. As well, possible_frameshift_peptides.txt/.tsv is a list/table of peptides associated with chimeric frameshifted protein sequences.

### Classifying Identified Peptides

all_peptides.txt and/or possible_frameshift_peptides.txt can be used as an input for fs_pep_utilities_script_updated_enz_rules_v17.py; this script will take a list of input peptides and query a fasta file mapping peptide sequences to predicted frameshift protein sequences. The script classifies identified peptides as originating from only the zero frame, straddling the transition between zero frame and frameshift sequence, only the frameshift sequence, or a mixture of these categories (as a single peptide sequence may arise from different protein sequences). The query generated possible_frameshift_peptides_classed.tsv and all_peptides_classed.tsv (along with summary .txt files). 
The command and arguments used for these queries are provided in utility_script_queries.txt and documentation for the utility script is provided in readme_fs_pep_utilities_v11.txt. The file used to map peptides to parent proteins was not_trimmed_with_all_zf_v101o_fs_pep_all_msfrag_nme_always_peptide2parent.tsv.gz
The outputs from these queries are used as the input for 02_query_tool_output.R

### Reporting the Results of Second Pass Search

02_query_tool_output.R and 03_spectral_data.R write their outputs to /output_tables:

The outputs of the utility script (possible_frameshift_peptides_classed.tsv and all_peptides_classed.tsv) were analyzed with 02_query_tool_output.R. 
This script generates tables of the identified and classified peptides along with information about the predicted frameshift.
classified_peptides_data.tsv contains all the peptides associated with predicted frameshift sequences.
frameshift_seq_peptides.tsv is the subset of these peptides that map to only the frameshifted region of the chimeric sequence, transitional_seq_peptides.tsv contains the subset that only map to the transition between the zero-frame and frameshifted sequence, transitional_and_frameshift_peptides.tsv contains both subsets, and zeroframe_frameshift_stop.tsv contains the subset of peptides originating from a possible early stop via frameshift. 

### Pulling Relevant Mass Spectrometry Data for Peptides of Interest

03_spectral_data.R is used to generate transitional_and_frameshift_peptides_MSdata.tsv and hit_peptides_spectral_data.tsv. 
transitional_and_frameshift_peptides_MSdata.tsv is a long pivot of the combined_protein.tsv data from FragPipe for the peptides of interest, with IonQuant data.
hit_peptides_spectral_data.tsv is a table of the peptides of interest that contains the associated MS file, scan number, and the .xml file that contains information on the peptide identification; this table was generated by filtering transitional_and_frameshift_peptides_data.tsv for spectral counts and joining with the appropriate psm.tsv files from the second pass search.
